---
import Button from "./common/Button.astro";
---

<div
  id="install-pwa"
  class="fixed bottom-24 left-1/2 -translate-x-1/2 transform hidden z-50 w-[95%] max-w-md"
>
  <div
    class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-5 border border-gray-100 dark:border-gray-700"
  >
    <div class="flex flex-col gap-4">
      <div>
        <h3 class="font-bold text-lg mb-1 text-gray-900 dark:text-white">
          Installer Decival
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">
          Profitez d'une expérience optimale et accédez à l'application même
          hors ligne.
        </p>
      </div>
      <div class="flex gap-3 justify-end">
        <Button id="dismiss-install" variant="secondary" size="sm">
          Plus tard
        </Button>
        <Button id="install-button" variant="primary" size="sm">
          Installer
        </Button>
      </div>
    </div>
  </div>
</div>

<script>
  let deferredPrompt;

  const isStandalone = () => {
    return (
      (window as any).navigator.standalone ||
      window.matchMedia("(display-mode: standalone)").matches
    );
  };

  const isDismissed = () => {
    return sessionStorage.getItem("pwa-prompt-dismissed") === "true";
  };

  const showPrompt = () => {
    if (isStandalone() || isDismissed()) return;
    const installPWA = document.getElementById("install-pwa");
    installPWA?.classList.remove("hidden");
    installPWA?.classList.add("animate-fade-in-up");
  };

  const hidePrompt = () => {
    const installPWA = document.getElementById("install-pwa");
    installPWA?.classList.add("hidden");
  };

  // Handle browser's beforeinstallprompt
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    showPrompt();
  });

  // Handle install button click
  document
    .getElementById("install-button")
    ?.addEventListener("click", async () => {
      if (!deferredPrompt) return;

      deferredPrompt.prompt();
      const result = await deferredPrompt.userChoice;

      if (result.outcome === "accepted") {
        hidePrompt();
      }

      deferredPrompt = null;
    });

  // Handle dismiss button click
  document.getElementById("dismiss-install")?.addEventListener("click", () => {
    sessionStorage.setItem("pwa-prompt-dismissed", "true");
    hidePrompt();
  });

  // Hide if already installed
  window.addEventListener("appinstalled", () => {
    hidePrompt();
    deferredPrompt = null;
  });

  // Check on load (for iOS or browsers where prompt might be persistent)
  window.addEventListener("load", () => {
    if (isStandalone()) {
      hidePrompt();
    }
  });
</script>

<style>
  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translate(-50%, 1rem);
    }
    to {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  }

  .animate-fade-in-up {
    animation: fade-in-up 0.4s ease-out forwards;
  }
</style>
