---
import Layout from "../../layouts/Layout.astro";
import SubtractionTest from "../../components/tests/SubtractionTest.astro";
import TestNavigation from "../../components/tests/TestNavigation.astro";
import Button from "../../components/common/Button.astro";
import Modal from "../../components/common/Modal.astro";
import Toast from "../../components/common/Toast.astro";
import { createSubtractionTest } from "../../logic/subtractionLogic";
import { startNewTest, completeTest } from "../../stores/testStore";

// CrÃ©ation d'un test d'exemple
const test = createSubtractionTest(5);
const currentItem = test.items[0];

// DÃ©marrer le test
startNewTest(test);
---

<Layout title="Test de soustraction - Decival" currentPage="tests">
  <TestNavigation title="Test de soustraction" />

  <div class="container mx-auto px-4 py-8 mt-16">
    <div class="mb-6">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-600">
          Question <span id="currentQuestion">1</span>/<span id="totalQuestions"
            >{test.items.length}</span
          >
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
        <div
          class="bg-accent h-2 rounded-full"
          style="width: 20%"
          id="progressBar"
        >
        </div>
      </div>
    </div>

    <form id="testForm" class="mt-8">
      <SubtractionTest item={currentItem} isLastItem={false} />
    </form>
  </div>

  <Toast id="feedback-toast" />

  <audio id="correct-sound" preload="auto">
    <source src="/sounds/correct.mp3" type="audio/mpeg" />
  </audio>
  <audio id="incorrect-sound" preload="auto">
    <source src="/sounds/incorrect.mp3" type="audio/mpeg" />
  </audio>

  <Modal id="result-modal" title="RÃ©sultat">
    <div class="text-center py-4">
      <p class="text-xl mb-2">
        Votre rÃ©ponse est <span id="resultText" class="font-bold"></span>
      </p>
      <p class="text-gray-600">
        La bonne rÃ©ponse Ã©tait : <span id="correctAnswer" class="font-semibold"
        ></span>
      </p>
    </div>
    <div slot="footer" class="flex justify-end gap-3">
      <Button variant="primary" id="continueButton">Continuer</Button>
    </div>
  </Modal>

  <Modal id="test-complete-modal" title="Test terminÃ©">
    <div class="text-center py-4">
      <h3 class="text-xl font-bold mb-4">FÃ©licitations !</h3>
      <p class="mb-2">Vous avez terminÃ© le test de soustraction.</p>
      <div class="text-lg">
        Score : <span id="finalScore" class="font-bold text-accent">0</span>%
      </div>
      <p class="mt-4 text-sm text-gray-600">
        Consultez vos progrÃ¨s dans l'onglet "ProgrÃ¨s"
      </p>
    </div>
    <div slot="footer" class="flex justify-end gap-3">
      <a href="/tests" class="no-underline">
        <Button variant="secondary" data-modal-close>Fermer</Button>
      </a>
      <Button variant="primary" id="restartButton">Recommencer</Button>
    </div>
  </Modal>
</Layout>

<script>
  import {
    checkAnswer,
    createSubtractionTest,
    evaluateTest,
  } from "../../logic/subtractionLogic";
  import { completeTest, currentTest } from "../../stores/testStore";

  let test = currentTest.get() || createSubtractionTest(5);
  let currentQuestionIndex = 0;

  const form = document.getElementById("testForm");
  const resultModal = document.getElementById("result-modal");
  const testCompleteModal = document.getElementById("test-complete-modal");
  const currentQuestionElement = document.getElementById("currentQuestion");
  const progressBar = document.getElementById("progressBar");
  const continueButton = document.getElementById("continueButton");
  const restartButton = document.getElementById("restartButton");
  const correctSound = document.getElementById(
    "correct-sound",
  ) as HTMLAudioElement;
  const incorrectSound = document.getElementById(
    "incorrect-sound",
  ) as HTMLAudioElement;

  // @ts-ignore - La fonction est dÃ©finie dans le composant Toast
  const showToast = window.showToast_feedback;

  function playSound(isCorrect: boolean) {
    const sound = isCorrect ? correctSound : incorrectSound;
    if (sound) {
      sound.currentTime = 0;
      sound
        .play()
        .catch((err) => console.log("Erreur lors de la lecture du son:", err));
    }
  }

  function updateProgress() {
    if (currentQuestionElement) {
      currentQuestionElement.textContent = (
        currentQuestionIndex + 1
      ).toString();
    }
    if (progressBar) {
      const progress = ((currentQuestionIndex + 1) / test.items.length) * 100;
      progressBar.style.width = `${progress}%`;
    }
  }

  function showResult(
    isCorrect: boolean,
    userAnswer: number,
    correctAnswer: number,
  ) {
    const resultText = document.getElementById("resultText");
    const correctAnswerElement = document.getElementById("correctAnswer");

    if (resultText) {
      resultText.textContent = isCorrect ? "correcte !" : "incorrecte";
      resultText.className = `font-bold ${isCorrect ? "text-green-600" : "text-red-600"}`;
    }
    if (correctAnswerElement) {
      correctAnswerElement.textContent = correctAnswer.toString();
    }

    // Jouer le son et afficher le toast
    playSound(isCorrect);
    showToast(
      isCorrect ? "âœ¨ Bravo ! C'est correct !" : "ðŸ˜• Pas tout Ã  fait...",
      2000,
    );

    resultModal?.classList.remove("hidden");
  }

  function showTestComplete() {
    const results = evaluateTest(test);
    const finalScoreElement = document.getElementById("finalScore");
    if (finalScoreElement) {
      finalScoreElement.textContent = Math.round(results.score).toString();
    }

    // Sauvegarder le test terminÃ©
    test.endTime = new Date();
    test.status = "completed";
    completeTest(test);

    testCompleteModal?.classList.remove("hidden");
    showToast(`ðŸŽ‰ Test terminÃ© ! Score : ${Math.round(results.score)}%`, 4000);
  }

  function updateQuestion() {
    const testForm = document.getElementById("testForm");
    if (testForm) {
      const currentItem = test.items[currentQuestionIndex];
      testForm.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-lg mx-auto">
          <div class="text-center mb-8">
            <div class="text-4xl font-bold mb-6 flex items-center justify-center gap-4">
              <span>${currentItem.firstNumber}</span>
              <span class="text-accent">âˆ’</span>
              <span>${currentItem.secondNumber}</span>
            </div>

            <div class="w-full max-w-xs mx-auto">
              <div class="flex flex-col gap-1">
                <input
                  type="number"
                  name="answer"
                  required
                  min="0"
                  max="999"
                  class="w-full px-4 py-2 rounded-md border border-gray-300 text-center text-2xl focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
                  inputmode="numeric"
                  pattern="[0-9]*"
                />
              </div>
            </div>
          </div>

          <div class="flex justify-end gap-4">
            <button
              type="submit"
              class="inline-flex items-center justify-center px-6 py-3 text-lg font-medium rounded-md text-white bg-accent hover:bg-accent/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent"
            >
              ${currentQuestionIndex === test.items.length - 1 ? "Terminer" : "Suivant"}
            </button>
          </div>
        </div>
      `;

      const input = testForm.querySelector(
        'input[name="answer"]',
      ) as HTMLInputElement;
      if (input) {
        input.focus();
      }
    }
  }

  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = new FormData(e.target as HTMLFormElement);
      const answer = parseInt(formData.get("answer") as string);

      const currentItem = test.items[currentQuestionIndex];
      const isCorrect = checkAnswer(currentItem, answer);

      // Mise Ã  jour de l'item
      currentItem.userAnswer = answer;
      currentItem.isCorrect = isCorrect;

      showResult(isCorrect, answer, currentItem.correctAnswer!);
    });
  }

  if (continueButton) {
    continueButton.addEventListener("click", () => {
      resultModal?.classList.add("hidden");
      currentQuestionIndex++;

      if (currentQuestionIndex >= test.items.length) {
        showTestComplete();
      } else {
        updateProgress();
        updateQuestion();
      }
    });
  }

  if (restartButton) {
    restartButton.addEventListener("click", () => {
      test = createSubtractionTest(5);
      currentQuestionIndex = 0;
      updateProgress();
      updateQuestion();
      testCompleteModal?.classList.add("hidden");
      showToast("ðŸ”„ Nouveau test commencÃ© !", 2000);
    });
  }

  // Initialisation de la premiÃ¨re question
  updateQuestion();
</script>
